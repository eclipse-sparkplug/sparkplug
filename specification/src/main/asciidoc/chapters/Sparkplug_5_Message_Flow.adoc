////
Copyright © 2016-2021 The Eclipse Foundation, Cirrus Link Solutions, and others

This program and the accompanying materials are made available under the
terms of the Eclipse Public License v. 2.0 which is available at
https://www.eclipse.org/legal/epl-2.0.

SPDX-License-Identifier: EPL-2.0

_Sparkplug™ and the Sparkplug™ logo are trademarks of the Eclipse Foundation_
////

[[message_flow]]
== General Message Flow

An MQTT based SCADA system is unique in that the Primary Host Application is NOT responsible for
establishing and maintaining connections to the edge nodes as is the case in most existing legacy
poll/response device protocols. With an MQTT based architecture, both the Host Application as well
as the Edge Nodes establish MQTT Sessions with a central MQTT Server(s). This is the desired
functionality as it provides the necessary decoupling from any one application and any given device.
Additional MQTT clients can connect and subscribe to any of the real time data without impacting the
Primary Host Application.

Due to the nature of real time SCADA solutions, it is very important for the primary host
application and all connected Sparkplug Edge Nodes to have the MQTT Session STATE information for
each other. In order to accomplish this the Sparkplug™ Topic Namespace definitions for Birth/Death
Certificates along with the defined payloads provide both state and context between the Primary Host
Application and the associated Edge Nodes. In most use cases and solution scenarios there are two
primary reasons for this "designation" of a Primary Host Application:

[arabic]
. Only the Primary Host Application should have the permission to issue commands to end devices.
. In high availability and redundancy use cases where multiple MQTT Servers are used, Sparkplug Edge
Nodes need to be aware of whether the Primary Host Application has network connectivity to each
MQTT Server in the infrastructure. If the Primary Host Application STATE shows that an Edge Node
is connected to an MQTT Server that the Primary Host Application is *NOT* connected to, then the Edge
Node should connect to the next available MQTT Server where STATE for the Primary Host Application
is  ‘ONLINE’.

[[message_flow_primary_host_application_session_establishment]]
=== Primary Host Application Session Establishment

The Primary Host Application upon startup or reconnect will immediately try to create a Host MQTT
Session with the configured _MQTT Server infrastructure_. Note that the establishment of an Host
Application MQTT session is asynchronous of any other MQTT Client session. If Edge Nodes are already
connected to the _MQTT Server infrastructure_, the Primary Host Application will synchronize using
the STATE MQTT topic. If associated Edge Nodes are not connected, Primary Host Application will
register them when they publish their Sparkplug Edge Node Birth Certificate.

// TODO: This image below needs to swap subscribe/publish order

image:extracted-media/media/image7.png[image,width=660,height=492]

Figure 3 - Host Session Establishment

The session diagram in Figure 3 - Host Session Establishment shows a very simple topology with a
single MQTT Server. The steps outlined in the session diagram are defined as follows:

[arabic]
. Primary Host Application will try to create an MQTT Session using the MQTT CONNECT Control
Packet. A Death Certificate is constructed into the MQTT Will Topic and Will Payload of the of the
CONNECT Control Packet with a Will QoS set to 1 and Will Retain flag set to true. The MQTT CONNECT
control packet is acknowledged as successful with a valid MQTT CONNACK Control Packet. From this
point forward in time, the MQTT Server is ready to deliver a Host Death Certificate any time the
Primary Host Application MQTT Client loses connectivity to the MQTT Server.

. With the MQTT Session established, Primary Host Application MUST issue an MQTT subscription for
the defined Sparkplug Topic Namespace.
[tck-testable tck-id-message-flow-phid-sparkplug-subscription]#The subscription on the Sparkplug
Topic Namespace and the STATE topic MUST be done immediately after successfully establishing the
MQTT session and before publishing its own STATE message.#

. [tck-testable tck-id-message-flow-phid-sparkplug-state-publish]#Once an MQTT Session and the
Primary Host Application subscriptions on the Sparkplug Topic Namespace and STATE topics have been
established, the Primary Host Application will publish a new STATE message with a Payload of a
UTF-8 string of 'ONLINE'.#
The Primary Host Application is now ready to start receiving MQTT messages from any connected Edge
Node within the infrastructure. At this point, the Primary Host Application can update the MQTT
Client metrics in the Primary Host Application with a current state of ONLINE once each Edge Node
publishes it's Sparkplug NBIRTH and DBIRTH messages. Since the Primary Host Application is also
relying on the MQTT Session to the MQTT Server(s), the availability of MQTT Servers to the Primary
Host Application is also being monitored and reflected in the MQTT Client metrics in the Primary
Host Application.

. If at any point in time Primary Host Application loses connectivity with the defined MQTT
Server(s), the ONLINE state of the Server is immediately reflected in the MQTT Client metrics in the
Primary Host Application.
[tck-not-testable]#All metric data associated with any Sparkplug Edge Node that was connected to
that MQTT Server MUST be updated to a "*STALE*" data quality.#

[[message_flow_edge_node_session_establishment]]
=== Edge Node Session Establishment

[tck-testable tck-id-message-flow-eon-birth-publish-connect]#Any Edge Node in the MQTT
infrastructure MUST establish an MQTT Session prior to publishing NBIRTH and DBIRTH messages.#
[tck-testable tck-id-message-flow-eon-birth-publish-subscribe]#Any Edge Node in the MQTT
infrastructure MUST also verify the Primary Host Application is ONLINE via the STATE topic if a
primary host is configured for the Edge Node before publishing NBIRTH and DBIRTH messages.#
Most implementations of an Sparkplug Edge Node for real time SCADA systems will try to maintain a
persistent MQTT Session with the _MQTT Server Infrastructure_. But there are use cases where the
MQTT Session does not need to be persistent. In either case, an Edge Node can try to establish an
MQTT Session at any time and is completely asynchronous from any other MQTT Client in the
infrastructure. The only exception to this rule is the use case where there are multiple MQTT
Servers and a Primary Host Application.

image:extracted-media/media/image8.png[image,width=660,height=508]

Figure 4 - Edge Node MQTT Session Establishment

The session diagram in Figure 4 - Edge Node MQTT Session Establishment shows a very simple topology
with a single MQTT Server. The steps outlined in the session diagram are defined as follows:

[arabic]
. The Edge Node MQTT Client will attempt to create an MQTT connection to the available MQTT
Server(s) using the MQTT CONNECT Control Packet.
The Death Certificate constructed into the Will Topic and Will Payload follows the format defined
in section on link:#payloads_ndeath[NDEATH messages].

. Edge Node Death Certificate (NDEATH). The MQTT CONNECT Control Packet is acknowledged as
successful with a valid CONNACK Control Packet. From this point forward in time, the MQTT Server is
ready to deliver an Edge Node Death (NDEATH) Certificate to any subscribing MQTT Client any time
connectivity is lost.

. The subscription to NCMD level topics ensures that Edge Node targeted messages from the Primary
Host Application are delivered. The subscription to DCMD ensures that device targeted messages from
the Primary Host Application are delivered. In applications with multiple MQTT Servers and a
designated Primary Host Application, the subscription to STATE informs the Edge Node the current
state of the Primary Host Application. At this point the Edge node has fully completed the steps
required for establishing a valid MQTT Session with the Primary Host Application.

. Once an MQTT Session has been established, the Edge Node MQTT client MUST publish an application
level NBIRTH as defined link:#topics_birth_message_nbirth[here]. At this point, the Primary Host
Application will have all the information required to build out the Edge Node metric structure and
show the Edge Node in an "ONLINE" state once it publishes its NBIRTH and DBIRTH messages.

. If at any point in time the Edge Node MQTT Client loses connectivity to the defined MQTT Server(s),
a Death Certificate (NDEATH) is issue by the MQTT Server on behalf of the Edge Node. Upon receipt of
the Death Certificate, the Primary Host Application will set the state of the Edge Node to
‘OFFLINE’ and update all timestamp metrics related to this Edge Node. Any defined metrics will be set
to a "*STALE*" data quality.

[[message_flow_device_sensor_session_establishment]]
=== Device / Sensor Session Establishment

The Sparkplug Specification is provided to get real time process variable information from existing
and new end devices measuring, monitoring and controlling a physical process into an MQTT MOM
infrastructure and the Primary Host Application Industrial Internet of Things application platform.
In the context of this document an MQTT Device can represent anything from existing legacy
poll/response driven PLCs, RTUs, HART Smart Transmitter, etc., to new generation automation and
instrumentation devices that can implement a conformant MQTT client natively.

The preceding sections in this document detail how the Primary Host Application interacts with the
_MQTT Server infrastructure_ and how that infrastructure interacts with the notion of an Sparkplug
Edge Node. But to a large extent the technical requirements of those pieces of the infrastructure
have already been provided. For most use cases in this market sector the primary focus will be on
the implementation of the Sparkplug Specification between the native device and the Edge Node API’s.

In order to expose and populate the metrics from any intelligent device, the following simple
session diagram outlines the requirements:

image:extracted-media/media/image9.png[image,width=660,height=309]Figure 5 - MQTT Device Session
Establishment

The session diagram in Figure 5 - MQTT Device Session Establishment shows a simple topology with
all the Sparkplug elements in place i.e. Primary Host Application, MQTT Server(s), Sparkplug Edge
Node and this element, the device element. The steps outlined in the session diagram are defined as
follows:

This flow diagram assumes that at least one MQTT Server is available and operational within the
infrastructure. Without at least a single MQTT Server the remainder of the infrastructure is
unavailable.

[arabic]
. Assuming MQTT Server is available.

. Assuming the Primary Host Application established MQTT Session with the MQTT Server(s).

. The Session Establishment of the associated Sparkplug Edge Node is described in
link:#message_flow_edge_node_session_establishment[Edge Node Session Establishment]. This flow
diagram assumes that the Edge Node session has already been established with the Primary Host
Application. Depending on the target platform, the Edge Node may be a physical "Edge of Network"
gateway device polling physical legacy devices via Modbus, AB, DNP3.0, HART, etc, a MQTT enabled
sensor or device, or it might be a logical implementation of one of the Eclipse Tahu reference
implementations for prototype Edge Nodes running on the Raspberry PI platform. Regardless of the
implementation, at some point the device interface will need to provide a state and associated
metrics to publish to the MQTT infrastructure.

. State #4 in the session diagram represents the state at which the Edge Node is ready to report all
of its metric data to the MQTT Server(s) as defined in Sparkplug. It is the responsibility of the
Edge node (logical or physical) to put this information in a form defined in
link:#payloads_dbirth[DBIRTH messages].

. {blank}

. Device Birth Certificate (DBIRTH). Upon receiving the DBIRTH message, the Primary Host Application
can build out the proper metric structure and set the Sparkplug Device to 'online'.

. Following the Sparkplug Specification in link:#payloads_ddata[Device Data Messages] (DDATA), all
subsequent metrics are published to the Primary Host Application on a Report by Exception (RBE)
basis using the DDATA message format.

// TODO: This is a normative statement - but it is testable?
. If at any time the Sparkplug Device cannot provide real time information, the Sparkplug
Specification requires that an DDEATH be published. This will inform the Primary Host Application
that all metric information be set to a "*STALE*" data quality.

[[message_flow_general_mqtt_application_and_non_primary_applications]]
=== General MQTT applications and non-primary Applications.

As noted above, there is the notion of a Primary Host Application in the infrastructure that has the
required permissions to send commands to Edge Nodes and Sparkplug Devices and the fact that all Edge
Nodes need to know the Primary Host Application is connected to the same MQTT Server its connected
to or it needs to walk to another one in the infrastructure. Both are known requirements of a
mission critical SCADA system.

But unlike legacy SCADA system implementations, all real time process variable information being
published thru the MQTT infrastructure is available to any number of additional MQTT Clients in the
business that might be interested in subsets if not all of the real time data.

The *ONLY* difference between a Primary Host Application MQTT Client and Secondary Host Application
MQTT Clients is that Secondary Host Applicaiton MQTT Clients do *NOT* issue the STATE Birth/Death
certificates.

[[message_flow_primary_application_state_in_multiple_mqtt_server_topologies]]
=== Primary Application STATE in Multiple MQTT Server Topologies

For implementations with multiple MQTT Servers, there is one additional aspect that needs to be
understood and managed properly. When multiple MQTT Servers are available there is the possibility
of "stranding" an Edge Node if the Primary command/control of the Primary Host Application loses
network connectivity to one of the MQTT Servers. In this instance the Edge Node would stay properly
connected to the MQTT Server publishing information not knowing that Primary Host Application was not
able to receive the messages.
// TODO: This is a normative statement - but it is testable?
When using multiple MQTT Servers, the Primary Host Application instance must be configured to
publish a STATE Birth Certificate and all Edge Nodes need to subscribe to this STATE message.

[tck-testable tck-id-message_flow_primary_application_state_with_multiple_servers-state]#Regardless
of the number of MQTT Servers in a Sparkplug Infrastructure, every time a Primary Host Application
establishes a new MQTT Session with an MQTT Server, the STATE Birth Certificate defined in the
link:#payloads_desc_state[STATE description section] MUST be the first message that is published
after a successful MQTT Session is established with each MQTT Server.#

Sparkplug Edge Nodes in an infrastructure that provides multiple MQTT Servers can establish a
session to any one of the MQTT Servers.
[tck-testable tck-id-message_flow_primary_application_state_with_multiple_servers-single-server]#The
Edge Nodes MUST not connected to more than one server at any point in time.#
Upon establishing a session, the Edge Node should issue a subscription to the STATE message
published by Primary Host Application. Since the STATE message is published with the RETAIN message
flag set, MQTT will guarantee that the last STATE message is always available. The Edge Node should
examine the payload of this message to ensure that it is a value of "ONLINE". If the value is
"OFFLINE", this indicates the Primary Application has lost its MQTT Session to this particular MQTT
Server.
[tck-testable tck-id-message_flow_primary_application_state_with_multiple_servers-walk]#
If the Primary Host Application is OFFLINE as denoted via the STATE MQTT Message, the Edge Node MUST
terminate its session with this MQTT Server and move to the next available MQTT Server that is
available.#
[tck-testable tck-id-message_flow_primary_application_state_with_multiple_servers-walk]#The Edge
Node MUST also wait to publish its BIRTH sequence until an "ONLINE" STATE message is received by the
Edge Node.#
This use of the STATE message in this manner ensures that any loss of connectivity to an MQTT Server
to the Primary Host Application does not result in Edge Nodes being "stranded" on an MQTT server
because of network issues. The following message flow diagram outlines how the STATE message is
used when three (3) MQTT Servers are available in the infrastructure:

image:extracted-media/media/image11.png[image,width=660,height=304]

Figure 7 – Primary Host Application STATE flow diagram

[arabic]
// TODO: Should this be a normative statement? Are PHID REQUIRED?
. When an Edge Node is configured with multiple available MQTT Servers in the infrastructure it
should issue a subscription to the Primary Host Application STATE message. The Edge Nodes are free
to establish an MQTT Session to any of the available servers over any available network at any time
and examine the current STATE value. If the STATE message payload is ‘OFFLINE’ then the Edge Node
should disconnect and walk to the next available server.

// TODO: I don't think a tck-testable statement is required here as it is included elsewhere
. Upon startup, the configured Primary Host Application's MQTT Client MUST include the Primary Host
Application DEATH Certificate that indicates STATE is ‘OFFLINE’ with the message RETAIN flag set to
true in the MQTT Will Message. Then the Primary Host Application BIRTH Certificate will be published
with a STATE payload of ‘ONLINE’.

. As the Edge Node walks its available MQTT Server list, it will establish an MQTT Session with a
server that has a STATE message with a payload of ‘ONLINE’. The Edge Node can stay connected to
this server if its MQTT Session stays intact and it does not receive the Primary Host Application
DEATH Certificate.

. Having a subscription registered to the MQTT Server on the STATE topic will result in any change
to the current the Primary Host Application STATE being received immediately. In this case, a
network disruption causes the Primary Host Application MQTT Session to server #2 to be terminated.
This will cause the MQTT Server, on behalf of the now terminated the Primary Host Application MQTT
Client to publish the DEATH certificate to anyone that is currently subscribed to it. Upon receipt
of the Primary Host Application DEATH Certificate this Edge Node will move to the next MQTT Server
in its list.

. The Edge Node moved to the next available MQTT Server and since the current STATE on this server
is ‘ONLINE’, it can stay connected.

. In the meantime, the network disruption between Primary Host Application and MQTT Server #2 has
been corrected. The Primary Host Application has a new MQTT Session established to server #2 with an
update Birth Certificate of ‘ONLINE’. Now MQTT Server #2 is ready to accept new Edge Node session
requests.

[[message_flow_edge_node_ndata_and_ncmd_messages]]
=== Edge Node NDATA and NCMD Messages

We’ll start this section with a description of how metric information is published to the Primary
Host Application from an Edge Node in the MQTT infrastructure. The definition of an Edge Node is
generic in that it can represent both physical "Edge of Network Gateway" devices that are
interfacing with existing legacy equipment and a logical MQTT endpoint for devices that natively
implement the Sparkplug Specification. The link:#payloads_nbirth[NBIRTH Section] defines the Edge
Node Birth Certificate MQTT Payload and the fact that it can provide any number of metrics that will
be exposed in the Primary Host Application. Some examples of these will be "read only" such as:

* Edge Node Manufacture ID
* Edge Node Device Type
* Edge Node Serial Number
* Edge Node Software Version Number
* Edge Node Configuration Change Count
* Edge Node Position (if GPS device is available)
* Edge Node Cellular RSSI value (if cellular is being used)
* Edge Node Power Supply voltage level
* Edge Node Temperature

Other metrics may be dynamic and "read/write" such as:

* Edge Node Rebirth command to republish all Edge Node and Device Birth Certificates
* Edge Node Next server command to move to next available MQTT Server
* Edge Node Reboot command to reboot the Edge Node
* Edge Node Primary Network (PRI_NETWORK) where 1 = Cellular, 2 = Ethernet

The important point to realize is that the metrics exposed in the Primary Host Application for use
in the design of applications are completely determined by what metric information is published in
the NBIRTH. This is entirely dependent on the application and use-case. Each specific Edge Node can
best determine what data to expose, and how to expose it, and it will automatically appear in the
Primary Host Application metric structure. Metrics can even be added dynamically at runtime and with
a new NBIRTH and DBIRTH sequence of messages. These metrics will automatically be added to the
Primary Host Application metric structure.

// This needs a bit of cleanup to be precise with non-normative MQTT concepts (e.g. ACLs)
The other very important distinction to make here is that Edge Node NDATA and NCMD messages are
decoupled from the Sparkplug Device level data and command messages of DDATA and DCMD. This
decoupling in the Topic Namespace is important because it allows interaction from all MQTT Clients
in the system (to the level of permission and application) with the Edge Nodes, but NOT to the level
of sending device commands. The Primary Host Application could provide a configuration parameter
that would BLOCK output DDATA and DCMD messages but still allow NDATA and NCMD messages to flow. In
this manner, multiple application systems can be connected to the same MQTT infrastructure, but only
the ones with DCMD enabled can publish Device commands.

The following simple message flow diagram demonstrates the messages used to update a changing
cellular RSSI value in the Primary Host Application and sending a command from the Primary Host
Application to the Edge Node to use a different primary network path.

image:extracted-media/media/image10.png[image,width=660,height=303]

Figure 6 - Edge Node NDATA and NCMD Message Flow

[arabic]
. Assuming MQTT Server is available.
. Assuming the Primary Host Application established MQTT Session with the MQTT Server(s).
. The Edge Node has an established MQTT Session and the NBIRTH has been published. Primary Host
Application now has all defined metrics and their current value.
. The Edge Node is monitoring its local cellular RSSI level. The level has changed and now the Edge
Node wants to publish the new value to the associated metric in Primary Host Application.
. From an operational requirement, the Edge Node needs to be told to switch its primary network
interface from cellular to Ethernet. From the Primary Host Application, the new metric value is
published to the Edge Node using a NCMD Sparkplug message.

[[message_flow_mqtt_enabled_device_session_establishment]]
=== MQTT Enabled Device Session Establishment
 TODO
 
[[message_flow_mqtt_application_node_session_establishment]]
=== MQTT Application Node Session Establishment
 TODO

[[message_flow_data_publish]]
=== Data Publish
 TODO

[[message_flow_commands]] 
=== Commands
 TODO
